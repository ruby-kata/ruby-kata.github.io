<!DOCTYPE html>
<html>
    <head>
        <title>Kata</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
        <link rel="stylesheet" href="./codekata.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/keymap/sublime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
        <script src="https://codemirror.net/mode/ruby/ruby.js"></script>
        <script type="module">
            import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.5.0/dist/browser/+esm";
            import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

            window.Stimulus = Application.start()

            Stimulus.register("testcases", class extends Controller {
                static values = { url: String }

                connect() {
                    this.load()
                }

                load() {
                    fetch(this.urlValue)
                        .then(response => response.text())
                        .then(testcases => {
                            this.element.value = testcases
                        })
                        .catch(error => console.log(error))
                }
            })

            Stimulus.register("codekata", class extends Controller {
                connect() {
                    this.setup()
                }

                async setup() {
                    this.editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        mode: "ruby",
                        lineNumbers: true,
                        keyMap: 'sublime',
                        extraKeys: {
                            "Alt-Up": "swapLineUp",
                            "Alt-Down": "swapLineDown",
                        }
                    });
                    this.editor.setValue(`# code-kata
def fizzbuzz(length)

end
                    `)
                
                    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/ruby+stdlib.wasm");
                    const module = await WebAssembly.compileStreaming(response);
                    const { vm } = await DefaultRubyVM(module);
                    this.vm = vm
                }
                
                async run() {
                    const testHelper = await fetch("https://ruby-kata.github.io/test_helper/assertion.rb")
                    const code = this.editor.getValue()
                    const testcases = document.getElementById('testcases').value
                    const result = this.vm.eval(`
                        begin
                            ${code}

                            ${testHelper.text()}

                            run('${testcases}')
                        rescue => error
                            error
                        end
                    `);
                    document.getElementById('result').value = result
                }
            })
      </script> 
    </head>
  
    <body>
        <div data-controller="codekata" class="page">
            <textarea class="kata" readonly>
fizzbuzz

Write a program that prints the numbers from 1 to 100. 
But for multiples of three print "Fizz" instead of the number and for the multiples of five print "Buzz". 
For numbers which are multiples of both three and five print "FizzBuzz".

"1,2,Fizz,4,Buzz,Fizz,7,8,Fizz,Buzz,11,Fizz,13,14,FizzBuzz,16,...,Buzz,Fizz,97,98,Fizz,Buzz"

            </textarea>
            <div class="solution">
                <textarea id="editor"></textarea>
                <textarea id="testcases" class="result" data-controller="testcases" data-testcases-url-value="https://ruby-kata.github.io/fizzbuzz/testcases.rb">
                </textarea>
                <button data-action="click->codekata#run" class="run">run</button>
                <textarea id="result" class="result" readonly>
                </textarea>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html">./ruby-kata-list</a><span>/fizzbuzz</span>
        </div>
    </body>
</html>