<!DOCTYPE html>
<html>
    <head>
        <title>Kata</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
        <link rel="stylesheet" href="./codekata.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/keymap/sublime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
        <script src="https://codemirror.net/mode/ruby/ruby.js"></script>
        <script type="module">
            import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.5.0/dist/browser/+esm";
            import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

            window.Stimulus = Application.start()

            Stimulus.register("testcases", class extends Controller {
                static values = { url: String }

                connect() {
                    this.load()
                }

                load() {
                    console.log("load ...")
                    fetch(this.urlValue)
                        .then(response => {
                            console.log(response)
                            response.text()
                        })
                        .then(html => {
                            console.log(html)
                            this.element.innerHTML = html
                        })
                        .catch(error => console.log(error))
                }
            })

            Stimulus.register("codekata", class extends Controller {
                connect() {
                    this.setup()
                }

                async setup() {
                    this.editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        mode: "ruby",
                        lineNumbers: true,
                        keyMap: 'sublime',
                        extraKeys: {
                            "Alt-Up": "swapLineUp",
                            "Alt-Down": "swapLineDown",
                        }
                    });
                    this.editor.setValue(`# code-kata`)
                
                    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/ruby+stdlib.wasm");
                    const module = await WebAssembly.compileStreaming(response);
                    const { vm } = await DefaultRubyVM(module);
                    this.vm = vm
                }
                
                run() {
                    const code = this.editor.getValue()
                    const result = this.vm.eval(`
                        begin
                            expected = "1,2,Fizz,4,Buzz,Fizz,7,8,Fizz,Buzz,11,Fizz,13,14,FizzBuzz,16,17,Fizz,19,Buzz,Fizz,22,23,Fizz,Buzz,26,Fizz,28,29,FizzBuzz,31,32,Fizz,34,Buzz,Fizz,37,38,Fizz,Buzz,41,Fizz,43,44,FizzBuzz,46,47,Fizz,49,Buzz,Fizz,52,53,Fizz,Buzz,56,Fizz,58,59,FizzBuzz,61,62,Fizz,64,Buzz,Fizz,67,68,Fizz,Buzz,71,Fizz,73,74,FizzBuzz,76,77,Fizz,79,Buzz,Fizz,82,83,Fizz,Buzz,86,Fizz,88,89,FizzBuzz,91,92,Fizz,94,Buzz,Fizz,97,98,Fizz,Buzz"
                            reality = ${code}

                            if reality == expected
                                "OK"
                            else
                                "FAILED\n-------------------------------------------\n" + 
                                "expected: #{expected} \n\n" + 
                                "received:\n #{reality} \n\n"
                            end
                        rescue => error
                            error
                        end
                    `);
                
                    document.getElementById('result').textContent = result
                }
            })
      </script> 
    </head>
  
    <body>
        <div data-controller="codekata" class="page">
            <textarea class="kata" readonly>
fizzbuzz

Write a program that prints the numbers from 1 to 100. 
But for multiples of three print "Fizz" instead of the number and for the multiples of five print "Buzz". 
For numbers which are multiples of both three and five print "FizzBuzz".

"1,2,Fizz,4,Buzz,Fizz,7,8,Fizz,Buzz,11,Fizz,13,14,FizzBuzz,16,...,Buzz,Fizz,97,98,Fizz,Buzz"

            </textarea>
            <div class="solution">
                <textarea id="editor"></textarea>
                <button data-action="click->codekata#run" class="run">run</button>
                <textarea id="result" class="result" data-controller="testcases" data-testcases-url-value="./fizzbuzz/testcases.txt">
                </textarea>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html">./ruby-kata-list</a><span>/fizzbuzz</span>
        </div>
    </body>
</html>