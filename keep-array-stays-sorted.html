<!DOCTYPE html>
<html>
    <head>
        <title>Kata</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.css">
        <link rel="stylesheet" href="./codekata.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.js"></script>
        <script src="https://codemirror.net/mode/ruby/ruby.js"></script>
        <script type="module">
            import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.5.0/dist/browser/+esm";
            import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

            window.Stimulus = Application.start()

            Stimulus.register("codekata", class extends Controller {
                connect() {
                    this.setup()
                }

                async setup() {
                    console.log(document.getElementById('editor'))
                    console.log(CodeMirror)
                    this.editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        mode: "ruby",
                        lineNumbers: true,
                    });
                    this.editor.setValue(`# code-kata
class SortedArray

end                    
                    `)
                
                    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/ruby+stdlib.wasm");
                    const module = await WebAssembly.compileStreaming(response);
                    const { vm } = await DefaultRubyVM(module);
                    this.vm = vm
                }
                
                run() {
                    const code = this.editor.getValue()
                    const result = this.vm.eval(`
                        begin
                            ${code}

                            a = SortedArray.new([3,2,1])
                            count = 0
                            (testcases = [
                                ['a', [1,2,3]],
                                ['a << -1', [-1, 1, 2, 3]],
                                ['a << 1.5', [-1, 1, 1.5, 2, 3]],
                                ['a.push(2.5)', [-1, 1, 1.5, 2, 2.5, 3]],
                                ['a.unshift(1.6)', [-1, 1, 1.5, 1.6, 2, 2.5, 3]],
                                ['a.collect! { |x| x * -1 }', [-3, -2.5, -2, -1.6, -1.5, -1, 1]],
                                ['a[3] = 25\na', [-3, -2.5, -2, -1.5, -1, 1, 25]],
                                ['a[1..2] = [6000, 10, 600, 6]\na', [-3, -1.5, -1, 1, 6, 10, 25, 600, 6000]],
                                ['a += [0, -10]', [-10, -3, -1.5, -1, 0, 1, 6, 10, 25, 600, 6000]]
                            ]).map { |func, expected|
                                reality = eval(func)
                                reality == expected ? (count += 1) && "assert_equal #{func}, #{expected} # OK" : "assert_equal #{func}, #{expected} # FAILED get: #{reality.nil? ? 'nil' : reality}"
                            }
                            .join('\n') + "\n--------------------------------------\nOK: #{count}, FAILED: #{testcases.size - count}"
                        rescue => error
                            error
                        end
                    `);
                
                    document.getElementById('result').textContent = result
                }
            })
      </script> 
    </head>
  
    <body>
        <div data-controller="codekata" class="page">
            <textarea class="kata" readonly>
keep-array-stays-sorted
Ruby Cookbook
Kata11: Sorting It Out (http://codekata.com/kata/kata11-sorting-it-out/)

You want to make sure an array stays sorted, even as you replace its elements or add
new elements to it.

a = SortedArray.new([3,2,1]) # => [1, 2, 3]

a << -1 # => [-1, 1, 2, 3]
a << 1.5 # => [-1, 1, 1.5, 2, 3]
a.push(2.5) # => [-1, 1, 1.5, 2, 2.5, 3]
a.unshift(1.6) # => [-1, 1, 1.5, 1.6, 2, 2.5, 3]
a.collect! { |x| x * -1 } # => [-3, -2.5, -2, -1.6, -1.5, -1, 1]
a[3] = 25
a # => [-3, -2.5, -2, -1.5, -1, 1, 25]
a[1..2] = [6000, 10, 600, 6]
a # => [-3, -1.5, -1, 1, 6, 10, 25, 600, 6000]
a += [0, -10] # => [-10, -3, -1.5, -1, 0, 1, 6, 10, 25, 600, 6000]


            </textarea>
            <div class="solution">
                <textarea id="editor"></textarea>
                <button data-action="click->codekata#run" class="run">run</button>
                <textarea id="result" class="result" readonly>
a = SortedArray.new([3,2,1])
assert_equal a, [1,2,3]
a << -1
assert_equal a, [-1,1,2,3]
a << 1.5
assert_equal a, [-1, 1, 1.5, 2, 3]
a.push(2.5)
assert_equal a, [-1, 1, 1.5, 2, 2.5, 3]
a.unshift(1.6)
assert_equal a, [-1, 1, 1.5, 1.6, 2, 2.5, 3]
a.collect! { |x| x * -1 } 
assert_equal a, [-3, -2.5, -2, -1.6, -1.5, -1, 1]
a[3] = 25
assert_equal a, [-3, -2.5, -2, -1.6, -1.5, -1, 1, 25]
a[1..2] = [6000, 10, 600, 6]
assert_equal a, [-3, -1.5, -1, 1, 6, 10, 25, 600, 6000]
a += [0, -10]
assert_equal a, [-10, -3, -1.5, -1, 0, 1, 6, 10, 25, 600, 6000]

                </textarea>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html">./ruby-kata-list</a><span>/keep-array-stays-sorted</span>
        </div>
    </body>
</html>