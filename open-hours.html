<!DOCTYPE html>
<html>
    <head>
        <title>Kata</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.css">
        <link rel="stylesheet" href="./codekata.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.js"></script>
        <script src="https://codemirror.net/mode/ruby/ruby.js"></script>
        <script type="module">
            import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.5.0/dist/browser/+esm";
            import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

            window.Stimulus = Application.start()

            Stimulus.register("codekata", class extends Controller {
                connect() {
                    this.setup()
                }

                async setup() {
                    console.log(document.getElementById('editor'))
                    console.log(CodeMirror)
                    this.editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        mode: "ruby",
                        lineNumbers: true,
                    });
                    this.editor.setValue(`# ruby-kata
class OpeningHours
    def self.config(open_days:, open_hours:)
        # your implement
    end

    def self.isOpenOn(day)
        # your implement
    end

    def self.nextOpeningDate(day)
        # your implement
    end
end
                    `)
                
                    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/ruby+stdlib.wasm");
                    const module = await WebAssembly.compileStreaming(response);
                    const { vm } = await DefaultRubyVM(module);
                    this.vm = vm
                }
                
                run() {
                    const code = this.editor.getValue()
                    const testcases = `
                        OpeningHours.config(open_days: ['Mon', 'Wed', 'Fri'], open_hours: 8..16)
                        setup = "OpeningHours.config(open_days: ['Mon', 'Wed', 'Fri'], open_hours: 8..16)\n--------------------------------------\n"
                        
                        count = 0
                        cases = [
                            OpeningHours.isOpenOn('2016-05-11T12:22:11.824Z') == true ? (count += 1) && "assert OpeningHours.isOpenOn('2016-05-11T12:22:11.824Z')) # OK" : "assert_equal(true, OpeningHours.isOpenOn('2016-05-11T12:22:11.824Z')) # FAILED",
                            OpeningHours.isOpenOn('2016-05-12T12:22:11.824Z') == true ? (count += 1) && "assert OpeningHours.isOpenOn('2016-05-12T12:22:11.824Z')) # OK" : "assert OpeningHours.isOpenOn('2016-05-12T12:22:11.824Z')) # FAILED",
                            OpeningHours.nextOpeningDate('2016-05-12T12:22:11.824Z') == '2016-05-13T08:00:00.000Z' ? (count += 1) && "assert_equal '2016-05-13T08:00:00.000Z', OpeningHours.nextOpeningDate('2016-05-12T12:22:11.824Z') # OK" : "assert_equal '2016-05-13T08:00:00.000Z', OpeningHours.nextOpeningDate('2016-05-12T12:22:11.824Z') # FAILED",
                        ]
                        
                        setup + cases.join('\n') + "\n--------------------------------------\nOK: #{count}, FAILED: #{cases.size - count}"
                    `

                    const result = this.vm.eval(`
                        begin
                            ${code}
                            ${testcases}
                        rescue => error
                            error
                        end
                    `);
                
                    document.getElementById('result').textContent = result
                }
            })
      </script> 
    </head>
  
    <body>
        <div data-controller="codekata" class="page">
            <textarea class="kata" readonly>
opening-hours-kata
https://github.com/christian-fei/opening-hours-kata
                
Amy and Valerie, the shop owners, need you to develop a simple program that satisfies the following requirements:

    The opening days and hours of the shop need to be configurable, and can be scattered in the week (e.g. Mon, Wed, Fri from 08:00 to 16:00)
    Amy needs to display the date of the next opening on a billboard outside of the shop
    Amy also wants to display on the website of the shop whether it is opened or closed at the moment

Write a small module that follows this contract, so that Valerie can easily integrate it:

OpeningHours.isOpenOn(date)
OpeningHours.nextOpeningDate(date)

For example:

    Shop opening days: Mon, Wed, Fri
    Shop opening hours: 08:00 - 16:00

    wednesday = '2016-05-11T12:22:11.824Z'
    thursday = '2016-05-12T12:22:11.824Z'
    fridayMorning = '2016-05-13T08:00:00.000Z'

    OpeningHours.isOpenOn(wednesday) == true
    OpeningHours.isOpenOn(thursday) == false

    OpeningHours.nextOpeningDate(wednesday) === fridayMorning

            </textarea>
            <div class="solution">
                <textarea id="editor"></textarea>
                <button data-action="click->codekata#run" class="run">run</button>
                <textarea id="result" class="result" readonly>
OpeningHours.config(open_days: ['Mon', 'Wed', 'Fri'], open_hours: 8..16)
--------------------------------------
assert OpeningHours.isOpenOn('2016-05-11T12:22:11.824Z')
assert OpeningHours.isOpenOn('2016-05-12T12:22:11.824Z')
assert_equal '2016-05-13T08:00:00.000Z', OpeningHours.nextOpeningDate('2016-05-11T12:22:11.824Z')


                </textarea>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html">./ruby-kata-list</a><span>/open-hours</span>
        </div>
    </body>
</html>