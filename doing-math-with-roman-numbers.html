<!DOCTYPE html>
<html>
    <head>
        <title>Kata</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
        <link rel="stylesheet" href="./codekata.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/keymap/sublime.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
        <script src="https://codemirror.net/mode/ruby/ruby.js"></script>
        <script type="module">
            import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.5.0/dist/browser/+esm";
            import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

            window.Stimulus = Application.start()

            Stimulus.register("codekata", class extends Controller {
                connect() {
                    this.setup()
                }

                async setup() {
                    this.editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        mode: "ruby",
                        lineNumbers: true,
                        keyMap: 'sublime',
                        extraKeys: {
                            "Alt-Up": "swapLineUp",
                            "Alt-Down": "swapLineDown",
                        }
                    });
                    this.editor.setValue(`# code-kata
                 
                    `)
                
                    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.5.0/dist/ruby+stdlib.wasm");
                    const module = await WebAssembly.compileStreaming(response);
                    const { vm } = await DefaultRubyVM(module);
                    this.vm = vm
                }
                
                run() {
                    const code = this.editor.getValue()
                    const result = this.vm.eval(`
                        begin
                            ${code}

                            count = 0
                            part1 = (part1_cases = [
                                ['72.to_roman.to_s', 'LXXII'],
                                ['444.to_roman.to_s', 'CDXLIV'],
                                ['1979.to_roman.to_s', 'MCMLXXIX'],
                                ["Roman.to_arabic('MCMLXXIX')", 1979],
                                ["'MMI'.to_roman.to_arabic", 2001],
                                ["('MMI'.to_roman + 3).to_s", 'MMIV'],
                                ["(612.to_roman * 3.to_roman).to_s", 'MDCCCXXXVI'],
                                ["'MCMXCIX'.to_roman.succ.to_s", 'MM'],
                            ]).map { |func, expected|
                                reality = eval(func)
                                reality == expected ? (count += 1) && "assert_equal #{func}, #{expected} # OK" : "assert_equal #{func}, #{expected} # FAILED get: #{reality.nil? ? 'nil' : reality}"
                            }.join('\n')

                            part2 = (part2_cases = [
                                ["'IIII'.to_roman", ArgumentError.new('Invalid Roman number: IIII')],
                                ["'IVI'.to_roman", ArgumentError.new('Invalid Roman number: IVI')],
                                ["-10.to_roman", RangeError.new("-10 can't be represented as a Roman number.")]
                            ]).map { |func, expected|
                                begin
                                    reality = eval(func)
                                rescue => error
                                    (error.class == expected.class && error.message == expected.message) ? (count += 1) && "assert_raise #{expected} { #{func} } # OK" : "assert_raise #{expected} { #{func} } # FAILED get: #{error}"
                                end
                            }.join('\n')
                            
                            
                            part1 + "\n" + part2 + "\n--------------------------------------\nOK: #{count}, FAILED: #{part1_cases.size + part2_cases.size - count}"
                        rescue => error
                            error
                        end
                    `);
                
                    document.getElementById('result').textContent = result
                }
            })
      </script> 
    </head>
  
    <body>
        <div data-controller="codekata" class="page">
            <textarea class="kata" readonly>
doing-math-with-roman-numbers
Ruby Cookbook

You want to convert between Arabic and Roman numbers, 
or do arithmetic with Roman numbers and get Roman numbers as your result.

For example:

    72.to_roman # => LXXII
    444.to_roman # => CDXLIV
    1979.to_roman # => MCMLXXIX
    'MCMXLVIII'.to_roman # => MCMXLVIII
    Roman.to_arabic('MCMLXXIX') # => 1979
    'MMI'.to_roman.to_arabic # => 2001
    'MMI'.to_roman + 3 # => MMIV
    'MCMXLVIII'.to_roman # => MCMXLVIII
    612.to_roman * 3.to_roman # => MDCCCXXXVI
    (612.to_roman * 3).divmod('VII'.to_roman) # => [CCLXII, II]
    612.to_roman * 10000 # => 6120000 # Too big
    612.to_roman * 0 # => 0 # Too small
    'MCMXCIX'.to_roman.succ # => MM
    ('I'.to_roman..'X'.to_roman).collect # => [I, II, III, IV, V, VI, VII, VIII, IX, X]
    'IIII'.to_roman # ArgumentError: Invalid Roman number: IIII
    'IVI'.to_roman # ArgumentError: Invalid Roman number: IVI
    'IXV'.to_roman # ArgumentError: Invalid Roman number: IXV
    'MCMM'.to_roman # ArgumentError: Invalid Roman number: MCMM
    'CIVVM'.to_roman # ArgumentError: Invalid Roman number: CIVVM
    -10.to_roman # RangeError: -10 can't be represented as a Roman number.
    50000.to_roman # RangeError: 50000 can't be represented as a Roman number.

            </textarea>
            <div class="solution">
                <textarea id="editor"></textarea>
                <button data-action="click->codekata#run" class="run">run</button>
                <textarea id="result" class="result" readonly>
assert_equal 72.to_roman.to_s, 'LXXII'
assert_equal 444.to_roman.to_s, 'CDXLIV'
assert_equal 1979.to_roman.to_s, 'MCMLXXIX'
assert_equal Roman.to_arabic('MCMLXXIX'), 1979
assert_equal 'MMI'.to_roman.to_arabic, 2001
assert_equal ('MMI'.to_roman + 3).to_s, 'MMIV'
assert_equal (612.to_roman * 3.to_roman).to_s, 'MDCCCXXXVI'
assert_equal 'MCMXCIX'.to_roman.succ.to_s, 'MM'
assert_raise ArgumentError.new('Invalid Roman number: IIII') { 'IIII'.to_roman }
assert_raise ArgumentError.new('Invalid Roman number: IVI') { 'IVI'.to_roman }
assert_raise RangeError.new('-10 can't be represented as a Roman number.') { -10.to_roman }
                </textarea>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html">./ruby-kata-list</a><span>/solving-a-system-of-linear-equations</span>
        </div>
    </body>
</html>